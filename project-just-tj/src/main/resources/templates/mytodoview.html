<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="/webjars/bootstrap/5.3.0/js/bootstrap.min.js"></script>
<script src="/webjars/axios/1.4.0/dist/axios.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiEABF4e5f5R2jqmzbzg7CHX7MwM1Pkiw&libraries=places"></script>
<title>여행일정공유 서비스 여정</title>
<link rel="stylesheet" type="text/css" href="css/myplan.css">
<link rel="stylesheet" type="text/css" href="css/font.css">
<script type="text/javascript">	
	$(function(){
		$(".plusBox").click(function(){
			$(".detailBox").show();
			$(".plusBox").hide();
		})
		$(".back").click(function(){
			$(".detailBox").hide();
			$(".plusBox").show();
		})
		$(".deleteForm").submit(function(){
			if(!confirm('정말 삭제하시겠습니까?')){
				return false;
			}
		})
	})
	
	$(document).ready(function() {
	    let map;
	    let marker;
	    let geocoder;
	    let infowindow;

	    function initMap() {
	        const seoul = { lat: 37.5665, lng: 126.9780 }; 
	        
	        map = new google.maps.Map(document.getElementById('map'), {
	            center: seoul,
	            zoom: 15
	        });

	        geocoder = new google.maps.Geocoder();
	        infowindow = new google.maps.InfoWindow();

	        // 검색박스 자동완성 설정
	        const searchInput = document.getElementById('search-input');
	        const autocomplete = new google.maps.places.Autocomplete(searchInput);
	        autocomplete.bindTo('bounds', map);
	    }
	 // 검색 버튼 클릭 이벤트
	    $('#search-button').click(function(e) {
	    	e.preventDefault(); // 폼 제출 방지
	        searchLocation();
	    });
	    $('#search-input').keypress(function(e) {
            if (e.which == 13) {
                e.preventDefault(); // 폼 제출 방지
                searchLocation();
            }
        });
	 	
	 // 장소 검색 함수
	    function searchLocation() {
	        const address = $('#search-input').val();
	        
	        const request = {
	            query: address,
	            fields: ['name', 'geometry', 'formatted_address']
	        };
	        const service = new google.maps.places.PlacesService(map);
	        service.findPlaceFromQuery(request, function(results, status) {
	            if (status === google.maps.places.PlacesServiceStatus.OK) {
	                if (results[0]) {
	                    // 이전 마커 제거
	                    if (marker) {
	                        marker.setMap(null);
	                    }

	                    // 새로운 마커 생성
	                    const location = results[0].geometry.location;
	                    map.setCenter(location);
	                    
	                    marker = new google.maps.Marker({
	                        map: map,
	                        position: location
	                    });
	                 
                        $('#latitude').val(location.lat());
                        $('#longitude').val(location.lng());
                        $('#address').val(results[0].formatted_address);
	                    // 정보창 표시
	                    infowindow.setContent(
	                        '<div><strong>' + results[0].name + '</strong><br>' +
	                        results[0].formatted_address + '</div>'
	                    );
	                    infowindow.open(map, marker);
	                    $('#search-input').val(results[0].name);
	                }
	            } else {
	                alert('검색 결과를 찾을 수 없습니다.');
	            }
	        });
	 	}
        $('#addForm').submit(function(e) {
            if (!$('#latitude').val() || !$('#longitude').val()) {
                e.preventDefault();
                alert('위치를 먼저 선택해주세요.');
                return false;
            }
        });
        // 지도 초기화
        initMap();
    });
	function initMap() {
        /* 데이터가 있는 HTML 요소들로부터 지도 초기화 정보 불러오기 */
        var locations = document.querySelectorAll('.location');
        locations.forEach(function (location) {
            var lat = parseFloat(location.dataset.latitude);
            var lng = parseFloat(location.dataset.longitude);
            var position = { lat: lat, lng: lng };
            
            var map = new google.maps.Map(location, {
                zoom: 15,
                center: position
            });

            var marker = new google.maps.Marker({
                position: position,
                map: map
            });
        });
    }
    window.onload = initMap;
    
</script>
</head>
<body>
	<header>
		여행 일정 공유 서비스
	</header>
	<nav>
		<div class="menu_bar">
			<div class="main" onclick="location.href='/'">
				MAIN
			</div>
			<div class="country" onclick="location.href='/my'">
				일정공유
			</div>
			<div onclick="location.href='/todo'">
				나의일정
			</div>
		</div>
	</nav>
	<section class="bg">
		<div class="listBox">
			<div class="titleBox">
				<div style="font-size: 18pt; font-weight: bold;">[[${todoVO.todo_title}]]</div>
				<div style="line-height: 35px;">[[${#dates.format(todoVO.reg_date,'YY/MM/dd')}]]</div>
			</div>
			<table class="listTable">
				<th:block th:each="dvo, stat : ${list}">
					<tr>
						<td style="font-weight: bold; font-size: 15pt;">[[${dvo.whatday}]]일차 [[${dvo.spot}]]</td>
						<td th:if="${dvo.time_info} != null">([[${dvo.time_info}]])</td>
					</tr>
					<tr style="height: 10px;">
						<td></td>
					</tr>
					<tr>
						<td colspan="2">
							<div class="location"
					             th:data-latitude="${dvo.latitude}" 
					             th:data-longitude="${dvo.longitude}">
					        </div>
						</td>
					</tr>
					<tr style="height: 10px;">
						<td></td>
					</tr>
					<tr>
						<td>[[${dvo.info}]]</td>
						<td>&nbsp;</td>
						<td style="text-align: right;">
							<form th:action="@{/deleteTodoList}" method="post" class="deleteForm">
								<input type="hidden" name="todo_id" th:value="${dvo.todo_id}"/>
								<input type="hidden" name="todo_list_id" th:value="${dvo.todo_list_id}"/>
								<input type="submit" class="btn btn-secondary btn-sm" value="삭제"/>
							</form>
						</td>
					</tr>
					<tr style="border-bottom: 1px solid lightgrey;">
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>&nbsp;</td>
					</tr>
				</th:block>
			</table>
			<div class="plusBox">
				<button class="btn btn-primary btn-sm" style="margin-right: 20px; font-weight: bold;">+</button>
			</div>
			<div class="detailBox">
				<form th:action="@{/todoListAdd}" method="post" id="addForm">
					<input type="hidden" name="todo_id" th:value="${todoVO.todo_id}"/>
					<select name="whatday" id="whatday" onchange="updateDateTime()" style="width: 40px;">
						<option th:each="i : ${#numbers.sequence(1, todoVO.days)}" th:value="${i}" th:text="${i}"></option>
					</select>
					<span>일차</span>
					<div>
						<input type="text" name="time_info" size="40" placeholder="웨이팅 등 시간정보"/>
					</div>
					<div id="search-container">
				        <input type="text" id="search-input" name="spot" size="50" placeholder="장소를 검색하세요">
				        <button id="search-button" class="btn btn-info btn-sm">검색</button>
				    </div>
				    <div id="map"></div>
				    <input type="hidden" id="latitude" name="latitude">
		            <input type="hidden" id="longitude" name="longitude">
		            <input type="hidden" id="address" name="address">
					<div style="margin: 5px auto;">
						<textarea name="info" id="info" cols="82" rows="3" placeholder="설명"></textarea>
					</div>
					<div style="text-align: right;">
						<input type="submit" class="btn btn-success btn-sm" value="저장"/>
						<input type="button" class="btn btn-secondary btn-sm" value="취소"/>
					</div>
				</form>
			</div>
		</div>
	</section>
</body>
</html>