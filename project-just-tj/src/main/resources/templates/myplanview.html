<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="/webjars/bootstrap/5.3.0/js/bootstrap.min.js"></script>
<script src="/webjars/axios/1.4.0/dist/axios.min.js"></script>
<title>여행일정공유 서비스 여정</title>
<link rel="stylesheet" type="text/css" href="css/myplan.css">
<link rel="stylesheet" type="text/css" href="css/font.css">
<script type="text/javascript">	
	$(function(){
		$(".plusBox").click(function(){
			$(".detailBox").show();
			$(".plusBox").hide();
		})
		$(".back").click(function(){
			$(".detailBox").hide();
			$(".plusBox").show();
		})
		$(".deleteForm").submit(function(){
			if(!confirm('정말 삭제하시겠습니까?')){
				return false;
			}
		})
		// 사진 슬라이드
		$(document).ready(function() {
            $('.container').each(function() {
                var $container = $(this);
                var $images = $container.find('.pic img');
                var index = 0;
                function updateButtons() {
                    $container.find('#next').toggle(index < $images.length - 1);
                    $container.find('#prev').toggle(index > 0);
                }
                $container.find('#next').on('click', function() {
                	if (index < $images.length - 1) {
                        $images.eq(index).hide();
                        index++;
                        $images.eq(index).show();
                    }
                    updateButtons();
                });
                $container.find('#prev').on('click', function () {
                    if (index > 0) {
                        $images.eq(index).hide();
                        index--;
                        $images.eq(index).show();
                    }
                    updateButtons();
                });
                $images.hide().eq(index).show();
                updateButtons();
            });
        });
		// 이미지 미리보기
		$("#file").on('change',function(){
			$("#previewBox").empty();
			var input = document.getElementById("file");
			var files = input.files;
			var filesArr = Array.prototype.slice.call(files);
			var a = 0;
			for (var i=0; i < files.length; i++) {
			var reader = new FileReader();
			reader.readAsDataURL(files[i]);
			reader.onloadend = function(e) {
				var lastModified = files[a].lastModified;
		       $("#previewBox").append('<div class="img_div" id="'+lastModified+'"><div class="i_div"><i class="bi bi-x-square" key="'+lastModified+'"></i></div><img id="view" src="'+e.target.result+'" class="img_div_img"/></div>');
		       a++;
		    }
		}
		}); 
		// 미리보기에서 선택 삭제
		$(document).on("click", ".i_div", function(e){
			var input = $("#file").prop('files');
			const dataTranster = new DataTransfer();
			var target = e.target;
			var removeId = $(target).attr("key");
			Array.from(input).filter(file => file.lastModified != removeId)
			.forEach(file => {
				dataTranster.items.add(file);
			});
			$("#file")[0].files = dataTranster.files;
			if (dataTranster.files.length == 0) {        
	        	$("#fileReset").hide();
	        }
			$("#"+removeId).remove();
			var input = $("file")[0].files;	
		}); 
	})
	// 멀티파일 업로드 체크
	function fileCheck(event) {
            const maxFiles = 5; 
            const input = event.target;
            const files = input.files;

            if (files.length > maxFiles) {
                alert(`${maxFiles} 개까지 첨부할 수 있습니다`);
                input.value = '';
            }
        }
</script>
</head>
<body>
	<header>
		여행 일정 공유 서비스
	</header>
	<nav>
		<div class="menu_bar">
			<div class="main" onclick="location.href='/'">
				MAIN
			</div>
			<div class="country" onclick="location.href='/country'">
				나라별
			</div>
			<div onclick="location.href='/my'">
				나의일정
			</div>
		</div>
	</nav>
	<section class="bg">
		<div class="listBox">
			<div class="titleBox">
				<div style="font-size: 18pt; font-weight: bold;">[[${planVO.title}]]</div>
				<div style="line-height: 35px;">[[${#dates.format(planVO.reg_date,'YY/MM/dd')}]]</div>
			</div>
			<table class="listTable">
				<th:block th:each="dvo : ${list}">
					<tr>
						<td style="font-weight: bold; font-size: 15pt;">[[${dvo.spot}]]</td>
						<td th:if="${dvo.visit_date} != null">(방문시간 : [[${#dates.format(dvo.visit_date,'MM/dd HH:mm')}]])</td>
						<td th:if="${dvo.time_info} != null">([[${dvo.time_info}]])</td>
					</tr>
					<tr style="height: 10px;">
						<td></td>
					</tr>
					<tr>
						<td>
							<div class="container" style="display: flex;">
								<div style="position: relative; top: 60px; width: 35px;">
									<button th:if="${dvo.img_count} > 1" class="btn btn-light btn-sm" id="prev"><i class="bi bi-arrow-left-circle"></i></button>
								</div>
								<div class="pic" style="overflow: hidden;">
									<th:block th:each="item: ${#numbers.sequence(1, dvo.img_count)}" >
										<img th:src="'https://objectstorage.ap-chuncheon-1.oraclecloud.com/n/axkuc5y2jvfb/b/bucket-20241206-1343/o/detail-'+ ${dvo.detail_id} +'-'+ ${item} + '.jpg'" alt="IMG" onerror="this.onerror=null; this.src='/images/noimg.jpg'" width="auto" height="150"/>
									</th:block>
								</div>
								<div style="position: relative; top: 60px; width: 35px;">
									<button th:if="${dvo.img_count} > 1" class="btn btn-light btn-sm" id="next"><i class="bi bi-arrow-right-circle"></i></button>
								</div>
							</div>
						</td>
						<td colspan="2">
							<div class="map">구글 지도</div>
						</td>
					</tr>
					<tr style="height: 10px;">
						<td></td>
					</tr>
					<tr>
						<td>[[${dvo.info}]]</td>
						<td>&nbsp;</td>
						<td style="text-align: right;">
							<form th:action="@{/deleteDetail}" method="post" class="deleteForm">
								<input type="hidden" name="plan_id" th:value="${dvo.plan_id}"/>
								<input type="hidden" name="detail_id" th:value="${dvo.detail_id}"/>
								<input type="submit" class="btn btn-secondary btn-sm" value="삭제"/>
							</form>
						</td>
					</tr>
					<tr style="border-bottom: 1px solid grey;">
						<td>&nbsp;</td>
					</tr>
					<tr>
						<td>&nbsp;</td>
					</tr>
				</th:block>
			</table>
			<div class="plusBox">
				<button class="btn btn-primary btn-sm" style="margin-right: 20px; font-weight: bold;">+</button>
			</div>
			<div class="detailBox">
				<form th:action="@{/detailAdd}" method="post" enctype="multipart/form-data">
					<input type="hidden" name="plan_id" th:value="${planVO.plan_id}"/>
					<select name="whatday">
						<option th:each="i : ${#numbers.sequence(1, planVO.days)}" th:value="${i}" th:text="${i}"></option>
					</select>
					<span>일차</span>
					<div style="margin: 5px auto;">
						<input type="text" name="spot" size="36" placeholder="장소명"/>
						<input type="datetime-local" name="visit_date" placeholder="방문시간" style="width: 190px;"/>
						<input type="text" name="time_info" placeholder="시간정보"/>
					</div>
					<div>
						<input type="file" name="file" id="file" accept=".jpg,.png,.gif" onchange="fileCheck(event)" multiple="multiple"/>
					</div>
					<div style="width: 600px;">
						<div class="form-group" id="previewBox" style="display: flex;"></div>
					</div>
					<div style="margin: 5px auto;">
						<textarea name="info" id="info" cols="90" rows="3" placeholder="설명"></textarea>
					</div>
					<div style="text-align: right; margin: 20px;">
						<input type="submit" value="저장"/>
						<input type="button" class="back" value="취소"/>
					</div>
				</form>
			</div>
		</div>
	</section>
</body>
</html>